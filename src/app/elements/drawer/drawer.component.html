<nz-drawer
  nzPlacement="right"
  nzWidth="720px"
  [nzMask]="false"
  [nzClosable]="true"
  [nzVisible]="showDrawer()"
  (nzOnClose)="close()"
  nzWrapClassName="elements-drawer-wrapper"
>
  <ng-container *nzDrawerContent>
    @if (showSetting()) {
      <nz-tabset [nzSelectedIndex]="currentTabIndex" (nzSelectChange)="onTabChange($event)">
        <nz-tab nzTitle="文件管理">
          @if (hasConnected()) {
            @if (iframeURL) {
              <iframe
                [src]="iframeURL | safeUrl"
                frameborder="0"
                style="width: 100%; height: calc(100vh - 170px)"
              >
              </iframe>
            } @else {
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  height: 400px;
                  color: #666;
                "
              >
                <nz-spin nzSimple></nz-spin>
                <span style="margin-left: 8px">正在加载文件管理器...</span>
              </div>
            }
          }
        </nz-tab>
        <nz-tab nzTitle="会话分享">
          @if (hasConnected()) {
            <div class="share-user-list">
              <nz-divider nzDashed [nzText]="text" nzOrientation="left">
                <ng-template #text>
                  <nz-icon nzType="team" nzTheme="outline" />
                  在线用户 ({{ onLineUsers.length }})
                </ng-template>
              </nz-divider>

              @if (onLineUsers.length > 0) {
                <div style="margin-bottom: 16px">
                  @for (item of onLineUsers; track item.terminal_id + item.primary) {
                    <nz-card
                      nzSize="small"
                      style="margin-bottom: 8px; border-radius: 8px"
                      [nzBodyStyle]="{ padding: '12px 16px' }"
                    >
                      <div
                        style="display: flex; align-items: center; justify-content: space-between"
                      >
                        <div>
                          <div
                            style="
                              font-weight: 500;
                              margin-bottom: 4px;
                              color: var(--el-text-color-light);
                            "
                          >
                            {{ item.user }}
                          </div>
                          <div style="display: flex; gap: 4px">
                            <nz-tag *ngIf="item.primary" nzColor="blue">
                              <nz-icon
                                nzType="crown"
                                nzTheme="outline"
                                style="margin-right: 2px"
                              ></nz-icon>
                              主用户
                            </nz-tag>
                            <nz-tag *ngIf="item.writable" nzColor="green">
                              <nz-icon
                                nzType="edit"
                                nzTheme="outline"
                                style="margin-right: 2px"
                              ></nz-icon>
                              可写
                            </nz-tag>
                            <nz-tag *ngIf="!item.writable" nzColor="orange">
                              <nz-icon
                                nzType="eye"
                                nzTheme="outline"
                                style="margin-right: 2px"
                              ></nz-icon>
                              只读
                            </nz-tag>
                          </div>
                        </div>

                        <div
                          style="margin-left: 12px"
                          [style.display]="item.primary ? 'none' : 'block'"
                        >
                          <button
                            nz-button
                            nzType="text"
                            nzSize="small"
                            nzDanger
                            nz-popconfirm
                            nzPopconfirmTitle="确定要移除该用户吗？"
                            nzPopconfirmPlacement="topRight"
                            (nzOnConfirm)="onDeleteShareUser(item)"
                            [disabled]="item.primary"
                            nzPopconfirmOverlayClassName="share-user-delete-button"
                            style="border: none; box-shadow: none"
                          >
                            <nz-icon nzType="close" nzTheme="outline"></nz-icon>
                          </button>
                        </div>
                      </div>
                    </nz-card>
                  }
                </div>
              } @else {
                <nz-empty
                  nzNotFoundImage="simple"
                  nzNotFoundContent="暂无在线用户"
                  style="margin: 20px 0"
                ></nz-empty>
              }
            </div>

            <button
              nz-button
              nzBlock
              nzType="primary"
              class="share-button"
              (click)="onCreateShareLink()"
              style="border-radius: 8px; height: 40px"
            >
              <nz-icon nzType="usergroup-add" nzTheme="outline"></nz-icon>
              创建分享链接
            </button>
          }
        </nz-tab>
      </nz-tabset>
    }

    @if (showChat()) {
      <iframe
        [src]="chatIframeURL | safeUrl"
        frameborder="0"
        style="width: 100%; height: calc(100vh - 170px)"
      ></iframe>
      <!-- <nz-card nzTitle="在线聊天" [nzExtra]="chatStatus" nzSize="small" class="chat-card">
        <div class="chat-messages-container">
          <nz-comment nzAuthor="张三" nzDatetime="11:32">
            <nz-avatar
              nz-comment-avatar
              nzIcon="user"
              nzSrc="https://zos.alipayobjects.com/rmsportal/ODTLcjxAfvqbxHnVXCYX.png"
            ></nz-avatar>
            <nz-comment-content>
              <nz-card class="message-bubble received">
                <p>你好，文件传输出错了，能帮忙看下吗？</p>
              </nz-card>
            </nz-comment-content>
          </nz-comment>
          <nz-comment nzAuthor="我" nzDatetime="11:33">
            <nz-avatar
              nz-comment-avatar
              nzText="我"
              style="background-color: #1890ff"
            ></nz-avatar>
            <nz-comment-content>
              <nz-card class="message-bubble sent">
                <p>好的，我正在检查，请稍等。</p>
              </nz-card>
            </nz-comment-content>
          </nz-comment>
        </div>

        <div class="chat-input-container">
          <nz-divider></nz-divider>
          <nz-input-group [nzAddOnAfter]="sendButton">
            <textarea
              rows="2"
              nz-input
              placeholder="在此输入消息..."
              [nzAutosize]="{ minRows: 2, maxRows: 6 }"
            ></textarea>
          </nz-input-group>
          <ng-template #sendButton>
            <button nz-button nzType="primary">
              <span nz-icon nzType="send"></span>
              发送
            </button>
          </ng-template>
        </div>
      </nz-card>

      <ng-template #chatStatus>
        <nz-badge nzStatus="success" nzText="在线"></nz-badge>
      </ng-template> -->
    }
  </ng-container>
</nz-drawer>

<nz-modal
  nzCentered
  [(nzVisible)]="showCreateShareLinkModal"
  [nzTitle]="modalTitle"
  [nzContent]="modalContent"
  [nzFooter]="modalFooter"
  (nzOnCancel)="handleCancel()"
  nzWrapClassName="create-share-link-modal"
>
  <ng-template #modalTitle>
    @if (showCreateShareLinkForm) {
      创建分享链接
    } @else {
      分享链接
    }
  </ng-template>

  <ng-template #modalContent>
    @if (showCreateShareLinkForm) {
      <form nz-form nzLayout="vertical" [formGroup]="shareLinkForm">
        <nz-form-item>
          <nz-form-label>{{ 'ExpiredTime' | translate }}</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="expired_time" nzPlaceHolder="请选择过期时间">
              @for (option of shareExpiredOptions; track option.value) {
                <nz-option [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
              }
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>权限设置</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="action_permission" nzPlaceHolder="请选择权限类型">
              @for (permission of shareUserPermissions; track permission.value) {
                <nz-option [nzValue]="permission.value" [nzLabel]="permission.label"></nz-option>
              }
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>分享用户</nz-form-label>
          <nz-form-control>
            <nz-select
              nzShowSearch
              nzAllowClear
              nzServerSearch
              nzMode="multiple"
              formControlName="users"
              nzPlaceHolder="请输入用户名"
              (nzOnSearch)="debounceSearch($event)"
            >
              @if (!loading) {
                @for (o of searchedUserList; track o) {
                  <nz-option [nzValue]="o" [nzLabel]="o.username"></nz-option>
                }
              } @else {
                <nz-option nzDisabled nzCustomContent>
                  <nz-icon nzType="loading" class="loading-icon" />
                  Loading Data...
                </nz-option>
              }
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </form>
    }

    @if (showLinkResult) {
      <form nz-form nzLayout="vertical">
        <nz-form-item>
          <nz-form-label>分享链接</nz-form-label>
          <nz-form-control>
            <input nz-input [value]="shareLink" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>分享码</nz-form-label>
          <nz-form-control>
            <input nz-input [value]="shareCode" />
          </nz-form-control>
        </nz-form-item>
      </form>
    }
  </ng-template>

  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="handleCancel()">取消</button>

    @if (showCreateShareLinkForm) {
      <button nz-button nzType="primary" (click)="handleOk()">确认创建</button>
    }

    @if (showLinkResult) {
      <button nz-button nzType="primary" (click)="copyLink()">复制</button>
    }
  </ng-template>
</nz-modal>
